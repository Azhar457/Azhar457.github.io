<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Data Barang</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 py-10 px-4">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
      <h2 class="text-2xl font-bold mb-4 text-center">‚úèÔ∏è Edit Data Barang</h2>

      <form
        id="editForm"
        action="https://script.google.com/macros/s/AKfycbzk4nYKKYSPa7Z9_ZWkXYpHmnCAtV1D4sTCMFOUSOy4drAroIz-gLrzFGRLaeot3az6uA/exec"
        method="POST"
        class="space-y-4"
      >
        <div>
          <label class="block">Nomor (No)</label>
          <input
            name="no"
            id="no"
            type="number"
            readonly
            class="w-full p-2 border rounded bg-gray-100"
          />
        </div>
        <div>
          <label class="block">Nama Barang</label>
          <input
            name="namaBarang"
            id="namaBarang"
            required
            class="w-full p-2 border rounded"
          />
        </div>
        <div>
          <label class="block">Kategori</label>
          <input
            name="kategori"
            id="kategori"
            required
            class="w-full p-2 border rounded"
          />
        </div>
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block">Bagus</label>
            <input
              name="bagus"
              id="bagus"
              type="number"
              min="0"
              class="w-full p-2 border rounded"
              onchange="updateTotal()"
            />
          </div>
          <div>
            <label class="block">Kurang</label>
            <input
              name="kurang"
              id="kurang"
              type="number"
              min="0"
              class="w-full p-2 border rounded"
              onchange="updateTotal()"
            />
          </div>
          <div>
            <label class="block">Rusak</label>
            <input
              name="rusak"
              id="rusak"
              type="number"
              min="0"
              class="w-full p-2 border rounded"
              onchange="updateTotal()"
            />
          </div>
        </div>
        <input type="hidden" name="total" id="totalHidden" />
        <input type="hidden" name="fotoFolderLink" id="fotoFolderLinkHidden" />

        <div>
          <label class="block">Folder Foto</label>
          <div class="flex items-center space-x-2">
            <input
              id="fotoFolderDisplay"
              readonly
              class="flex-1 p-2 border rounded bg-gray-100"
            />
            <a
              id="fotoLink"
              href="#"
              target="_blank"
              class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >
              üìÅ Buka
            </a>
          </div>
        </div>
        <div>
          <label class="block">Keterangan</label>
          <textarea
            name="keterangan"
            id="keterangan"
            class="w-full p-2 border rounded"
          ></textarea>
        </div>
        <div>
          <button
            type="submit"
            id="submitBtn"
            class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600 disabled:opacity-50"
          >
            Simpan Perubahan
          </button>
        </div>
      </form>
      <p id="statusMsg" class="mt-4 text-center text-sm text-gray-700"></p>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const nomor = urlParams.get("no");
      const GET_URL =
        "https://script.google.com/macros/s/AKfycbzk4nYKKYSPa7Z9_ZWkXYpHmnCAtV1D4sTCMFOUSOy4drAroIz-gLrzFGRLaeot3az6uA/exec?action=getData";

      function updateTotal() {
        const bagus = parseInt(document.getElementById("bagus").value) || 0;
        const kurang = parseInt(document.getElementById("kurang").value) || 0;
        const rusak = parseInt(document.getElementById("rusak").value) || 0;
        const total = bagus + kurang + rusak;
        document.getElementById("totalHidden").value = total;
      }

      function loadData() {
        try {
          // Generate unique callback name
          const callbackName = "handleData_" + Date.now();

          // Create callback function
          window[callbackName] = function (rows) {
            try {
              const item = rows.find(
                (row) => String(row["No"]) === String(nomor)
              );

              if (!item) throw new Error("Data tidak ditemukan.");

              document.getElementById("no").value = item["No"];
              document.getElementById("namaBarang").value =
                item["Nama Barang"] || "";
              document.getElementById("kategori").value =
                item["Kategori"] || "";
              document.getElementById("bagus").value =
                item["Kondisi Bagus"] || 0;
              document.getElementById("kurang").value =
                item["Kondisi Kurang"] || 0;
              document.getElementById("rusak").value =
                item["Kondisi Rusak"] || 0;
              document.getElementById("keterangan").value =
                item["Keterangan"] || "";

              const fotoLink = item["Foto Folder Link"];
              if (fotoLink) {
                document.getElementById("fotoFolderDisplay").value = fotoLink;
                document.getElementById("fotoFolderLinkHidden").value =
                  fotoLink;
                document.getElementById("fotoLink").href = fotoLink;
              }

              updateTotal();
              document.getElementById("statusMsg").innerText =
                "‚úÖ Data berhasil dimuat";

              // Cleanup callback
              delete window[callbackName];
            } catch (err) {
              document.getElementById("statusMsg").innerText =
                "‚ùå Gagal memuat data: " + err.message;
              delete window[callbackName];
            }
          };

          // Load data using JSONP
          const script = document.createElement("script");
          script.src = GET_URL + "&callback=" + callbackName;
          script.onerror = function () {
            document.getElementById("statusMsg").innerText =
              "‚ùå Gagal memuat data dari server";
            delete window[callbackName];
          };
          document.head.appendChild(script);

          // Remove script after loading
          setTimeout(() => {
            if (script.parentNode) {
              script.parentNode.removeChild(script);
            }
          }, 5000);
        } catch (err) {
          document.getElementById("statusMsg").innerText =
            "‚ùå Gagal memuat data: " + err.message;
          console.error(err);
        }
      }

      document
        .getElementById("editForm")
        .addEventListener("submit", function (e) {
          const submitBtn = document.getElementById("submitBtn");
          const statusMsg = document.getElementById("statusMsg");

          updateTotal();

          submitBtn.disabled = true;
          submitBtn.textContent = "Menyimpan...";
          statusMsg.textContent = "Sedang memproses...";
        });

      // Load data saat halaman dimuat
      if (nomor) {
        document.getElementById("statusMsg").textContent = "Memuat data...";
        loadData();
      } else {
        document.getElementById("statusMsg").textContent =
          "‚ùå Nomor data tidak ditemukan di URL. Pastikan URL berisi ?no=123";
      }
    </script>
  </body>
</html>
