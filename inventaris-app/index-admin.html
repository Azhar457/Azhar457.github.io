<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Barang Rongsokan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">
            üë®‚Äçüíº Admin Panel - Barang Rongsokan
          </h1>
          <p class="text-gray-600">Kelola data barang rongsokan</p>
        </div>
        <a
          href="index.html"
          class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
        >
          üëÅÔ∏è Lihat Public View
        </a>
      </div>

      <!-- Search & Filter -->
      <div
        class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4"
      >
        <div class="flex gap-2 w-full sm:w-auto">
          <input
            id="searchInput"
            type="text"
            placeholder="Cari nama atau kategori..."
            class="flex-1 sm:w-80 p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            oninput="renderCards()"
          />
          <button
            onclick="fetchData()"
            class="bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 whitespace-nowrap"
          >
            üîÑ Refresh
          </button>
        </div>

        <!-- Sort Options -->
        <select
          id="sortBy"
          onchange="renderCards()"
          class="p-3 border rounded-lg bg-white"
        >
          <option value="newest">Terbaru</option>
          <option value="price-low">Harga Terendah</option>
          <option value="price-high">Harga Tertinggi</option>
          <option value="name">Nama A-Z</option>
        </select>
      </div>

      <!-- Loading indicator -->
      <div id="loadingMsg" class="text-center text-gray-500 py-8">
        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
        <p>Memuat data...</p>
      </div>

      <!-- Cards Container -->
      <div
        id="cardsContainer"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
      >
        <!-- cards will be inserted here -->
      </div>

      <!-- Pagination -->
      <div class="mt-8 flex justify-center items-center space-x-2">
        <button
          onclick="prevPage()"
          class="px-4 py-2 bg-blue-500 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
          id="prevBtn"
        >
          ‚Üê Sebelumnya
        </button>
        <span id="pageInfo" class="px-4 py-2 text-gray-700 font-medium"></span>
        <button
          onclick="nextPage()"
          class="px-4 py-2 bg-blue-500 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
          id="nextBtn"
        >
          Berikutnya ‚Üí
        </button>
      </div>
    </div>

    <script>
      const SHEET_URL =
        "https://opensheet.elk.sh/1DGkbjItvUBa6gGnwe16W4z_PcQMwAAdK8HB6pHgtxF4/Form%20Responses%201";
      const CARDS_PER_PAGE = 12;
      let currentPage = 1;
      let allData = [];
      let filteredData = [];

      function formatPrice(price) {
        if (!price) return "0";
        return parseInt(price).toLocaleString("id-ID");
      }

      // Function to convert Google Drive link to direct image URL
      function getDirectImageUrl(driveUrl) {
        if (!driveUrl) return "";

        // Extract file ID from various Google Drive URL formats
        let fileId = "";

        if (driveUrl.includes("drive.google.com")) {
          const matches = driveUrl.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
          if (matches) {
            fileId = matches[1];
          } else {
            const idMatch = driveUrl.match(/id=([a-zA-Z0-9_-]+)/);
            if (idMatch) {
              fileId = idMatch[1];
            }
          }

          if (fileId) {
            return `https://drive.google.com/uc?export=view&id=${fileId}`;
          }
        }

        return driveUrl; // Return original if not a Google Drive URL
      }

      async function fetchData() {
        try {
          document.getElementById("loadingMsg").style.display = "block";
          document.getElementById("cardsContainer").style.display = "none";

          const res = await fetch(SHEET_URL);
          const data = await res.json();

          // Filter data yang valid (ada nama barang)
          allData = data.filter(
            (row) => row["Nama Barang"] && row["Nama Barang"].trim() !== ""
          );

          document.getElementById("loadingMsg").style.display = "none";
          document.getElementById("cardsContainer").style.display = "grid";
          renderCards();
        } catch (error) {
          console.error("Gagal fetch data:", error);
          document.getElementById("loadingMsg").innerHTML = `
            <i class="fas fa-exclamation-triangle text-red-500 text-2xl mb-2"></i>
            <p class="text-red-500">‚ùå Gagal memuat data</p>
            <button onclick="fetchData()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">Coba Lagi</button>
          `;
        }
      }

      function renderCards() {
        const container = document.getElementById("cardsContainer");
        const search = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const sortBy = document.getElementById("sortBy").value;

        // Filter data
        filteredData = allData.filter(
          (row) =>
            (row["Nama Barang"] &&
              row["Nama Barang"].toLowerCase().includes(search)) ||
            (row["Kategori"] && row["Kategori"].toLowerCase().includes(search))
        );

        // Sort data
        filteredData.sort((a, b) => {
          switch (sortBy) {
            case "price-low":
              return (
                (parseInt(a["Harga Taksir"]) || 0) -
                (parseInt(b["Harga Taksir"]) || 0)
              );
            case "price-high":
              return (
                (parseInt(b["Harga Taksir"]) || 0) -
                (parseInt(a["Harga Taksir"]) || 0)
              );
            case "name":
              return (a["Nama Barang"] || "").localeCompare(
                b["Nama Barang"] || ""
              );
            case "newest":
            default:
              return (
                new Date(b["Timestamp"] || 0) - new Date(a["Timestamp"] || 0)
              );
          }
        });

        // Pagination
        const start = (currentPage - 1) * CARDS_PER_PAGE;
        const pageData = filteredData.slice(start, start + CARDS_PER_PAGE);

        if (pageData.length === 0) {
          container.innerHTML = `
            <div class="col-span-full text-center py-12">
              <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
              <p class="text-gray-500 text-lg">
                ${
                  allData.length === 0
                    ? "Belum ada barang tersedia"
                    : "Tidak ada barang yang sesuai pencarian"
                }
              </p>
            </div>
          `;
        } else {
          container.innerHTML = pageData.map(createCard).join("");
        }

        updatePagination();
      }

      function createCard(item, index) {
        const totalBarang =
          (parseInt(item["Jumlah Kondisi Bagus"]) || 0) +
          (parseInt(item["Jumlah Kondisi Kurang"]) || 0) +
          (parseInt(item["Jumlah Kondisi Rusak"]) || 0);

        const hargaTaksir = parseInt(item["Harga Taksir"]) || 0;
        const harga = parseInt(item["Harga"]) || 0;
        const fotoUrl = item["Foto Barang"] || "";

        // Convert Google Drive URL to direct image URL
        const directImageUrl = getDirectImageUrl(
          fotoUrl.split(",")[0]?.trim() || ""
        );

        // Calculate the actual row index for edit
        const rowIndex = allData.indexOf(item) + 1;

        return `
          <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 overflow-hidden">
            <!-- Image -->
            <div class="h-48 bg-gray-200 overflow-hidden">
              ${
                directImageUrl
                  ? `<img src="${directImageUrl}" alt="${item["Nama Barang"]}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-300" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzlmYTZiNyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg=='">`
                  : `<div class="w-full h-full bg-gray-200 flex items-center justify-center">
                     <i class="fas fa-image text-gray-400 text-3xl"></i>
                   </div>`
              }
            </div>
            
            <!-- Content -->
            <div class="p-4">
              <!-- Title & Category -->
              <h3 class="font-bold text-lg text-gray-800 mb-1 line-clamp-2">${
                item["Nama Barang"] || "Nama tidak tersedia"
              }</h3>
              <p class="text-sm text-blue-600 mb-2">üì¶ ${
                item["Kategori"] || "Kategori tidak tersedia"
              }</p>
              
              <!-- Condition -->
              <div class="mb-3">
                <p class="text-xs text-gray-600 mb-1">Kondisi Barang:</p>
                <div class="flex gap-1 text-xs flex-wrap">
                  <span class="bg-green-100 text-green-800 px-2 py-1 rounded">‚úÖ ${
                    item["Jumlah Kondisi Bagus"] || 0
                  }</span>
                  <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">‚ö†Ô∏è ${
                    item["Jumlah Kondisi Kurang"] || 0
                  }</span>
                  <span class="bg-red-100 text-red-800 px-2 py-1 rounded">‚ùå ${
                    item["Jumlah Kondisi Rusak"] || 0
                  }</span>
                </div>
                <p class="text-sm font-medium mt-1">Total: ${totalBarang} pcs</p>
              </div>
              
              <!-- Price -->
              <div class="mb-4">
                ${
                  hargaTaksir > 0
                    ? `
                  <p class="text-lg font-bold text-green-600">üí∞ Rp ${formatPrice(
                    hargaTaksir
                  )}</p>
                  <p class="text-xs text-gray-500">Harga taksir (minimal)</p>
                `
                    : '<p class="text-gray-500">Harga belum ditentukan</p>'
                }
                ${
                  harga > 0
                    ? `<p class="text-sm text-blue-600">Harga: Rp ${formatPrice(
                        harga
                      )}</p>`
                    : ""
                }
              </div>
              
              <!-- Admin Actions -->
              <div class="space-y-2">
                <a href="edit.html?nama=${encodeURIComponent(
                  item["Nama Barang"]
                )}" 
                   class="w-full bg-yellow-500 text-white py-2 px-3 rounded-lg hover:bg-yellow-600 transition-colors text-sm text-center block">
                  ‚úèÔ∏è Edit Barang
                </a>
                <div class="text-xs text-gray-500 text-center">
                  Row: ${rowIndex} | Email: ${item["Email Address"] || "N/A"}
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function updatePagination() {
        const totalPages = Math.ceil(filteredData.length / CARDS_PER_PAGE);
        document.getElementById(
          "pageInfo"
        ).innerText = `Halaman ${currentPage} dari ${totalPages || 1}`;
        document.getElementById("prevBtn").disabled = currentPage === 1;
        document.getElementById("nextBtn").disabled = currentPage >= totalPages;
      }

      function prevPage() {
        if (currentPage > 1) {
          currentPage--;
          renderCards();
          window.scrollTo(0, 0);
        }
      }

      function nextPage() {
        const totalPages = Math.ceil(filteredData.length / CARDS_PER_PAGE);
        if (currentPage < totalPages) {
          currentPage++;
          renderCards();
          window.scrollTo(0, 0);
        }
      }

      // Load data saat halaman dimuat
      fetchData();
    </script>
  </body>
</html>
